@using Project1Practice.Models
@model PhieuNhap

@{
    ViewBag.Title = "Nhập hàng";
    Layout = "~/Views/Layout/AdminLayout.cshtml";
}
@*Bước 1: Sử dụng control datetimepicker chèn 3 file script*@
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
@*Bước 2: Xây dựng 1 function để điều hướng thẻ html theo control datpicker*@
<script>
    $(function () {
        $(".date").datepicker();
    });
</script>

@{ IEnumerable<NhaCungCap> listNCC = ViewBag.MaNCC as IEnumerable<NhaCungCap>;}
<p class="home"><a href="#">Quản lý</a> > <strong> Quản lý Phiếu Nhập</strong></p>
<br />
<h2>NHẬP HÀNG</h2>
<br />
@using (Html.BeginForm())
{

    <div class="row">
        <div class="ThongtinPhieuNhap col-md-12">
            <div class="col-md-2">
                Nhà cung cấp:
            </div>
            <div class="col-md-5">
                <select class="MaNCC" name="MaNCC">
                    @foreach (var item in listNCC)
                    {
                        <option value="@item.MaNCC">@item.TenNCC</option>
                    }
                </select>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
    <br />
    <div class="col-md-12">
        <div class="col-md-2">
            Ngày nhập:
        </div>
        <div class="col-md-5">
            <input name="NgayNhap" type="text" class="date" />
        </div>
    </div>
    <div class="clearfix"></div>
    <br /><br /><br />


    <table class="table tblChiTietPhieuNhap">
        @{ IEnumerable<SanPham> listSP = ViewBag.ListSP as IEnumerable<SanPham>;}
        <tr class="trAppend" style="display:none;">
            <td>
                <select class="ddlSanPham" name="">
                    @foreach (var item in listSP)
                    {
                        <option value="@item.MaSP">@item.TenSP</option>
                    }
                </select>
            </td>
            <td>
                <input name="" class="txtDonGia" value="0" />
            </td>
            <td>
                <input name="" class="txtSoLuong" value="0" />
            </td>
            <td>
                <input name="" class="btnDelete btn btn-danger" style="width:30px;height:30px;" value="-" />
            </td>
        </tr>
        <tr class="trFirstChild" data-id="-1">
            <td>Sản phẩm</td>
            <td>Đơn giá nhập</td>
            <td>Số lượng nhập</td>
        </tr>
    </table>

    <input type="button" value="+" class="btn btn-warning" id="btnAdd" />
    <input type="submit" value="Nhập hàng" class="btn btn-primary" id="btnNhapHang" />
}


<script>
    $("#btnAdd").click(function () {
        //Lấy id của tr cuối cùng thuộc thẻ table có class = tblChiTietPhieuNhap
        //Phương thức find là tìm đến thẻ nào đó: ở đây là thẻ tr (:last-child) là thẻ tr cuối cùng trong thẻ tblChiTietPhieuNhap
        var id_cuoi = $(".tblChiTietPhieuNhap").find("tr:last-child").attr("data-id");
        i = parseInt(id_cuoi) + 1;
        //Nội dung phía trong thẻ trAppend
        var tdnoidung = $(".trAppend").html();
        //Tạo 1 thẻ tr bao ngoài nội dung
        var trnoidung = "<tr class=\"trAppended\" data-id=\"" + i + "\">" + tdnoidung + "</tr>";
        //Lấy thẻ table append vào 1 tr
        $(".tblChiTietPhieuNhap").append(trnoidung);
        loadIDLENTHE();
    });

    //Phương thức xử lý lấy thuộc tính attr từ thẻ tr gán xuống chỉ số phần tử các trong thuộc tính name của thẻ input

    function loadIDLENTHE() {
        $(".trAppended").each(function () {
            //Lấy thuộc tính data-id của thẻ tr hiện
            var id = $(this).attr("data-id");
            var nameMaPhieuNhap = "[" + id + "].MaPN";
            var nameMaSanPham = "[" + id + "].MaSP";
            var nameSoLuongNhap = "[" + id + "].SoLuongNhap";
            var nameDonGiaNhap = "[" + id + "].DonGiaNhap";
            $(this).find(".ddlSanPham").attr("name", nameMaSanPham); //Gán name cho ddlSanPham
            $(this).find(".txtDonGia").attr("name", nameDonGiaNhap);
            $(this).find(".txtSoLuong").attr("name", nameSoLuongNhap);
        })
    }

    function CapNhatID() {

        //Lấy lại tr 1
        var id_cuoi = $(".tblChiTietPhieuNhap").find(".trFirstChild").attr("data-id");
        i = parseInt(id_cuoi) + 1;

        $(".trAppended").each(function () {
            var id = i;
            $(this).attr("data-id", i);
            //Cập nhật lại id khi xóa
            var nameMaSanPham = "[" + id + "].MaSP";
            var nameSoLuongNhap = "[" + id + "].SoLuongNhap";
            var nameDonGiaNhap = "[" + id + "].DonGiaNhap";
            $(this).find(".ddlSanPham").attr("name", nameMaSanPham); //Gán name cho ddlSanPham
            $(this).find(".txtDonGia").attr("name", nameDonGiaNhap);
            $(this).find(".txtSoLuong").attr("name", nameSoLuongNhap);
            i++;
        });
    }

    $("body").delegate(".btnDelete", "click", function () {
        //Xóa phần thử cha phía ngoài
        $(this).closest(".trAppended").remove();
        //Cập nhật lại id
        CapNhatID();
    })

    $("#btnNhapHang").click(function () {
        if (kiemtraDonGia() == false) {
            //Nếu tồn tại 1 giá trị bất kỳ thuộc class đơn giá không phải số, thì ngăn không cho submit về server
            return false;
        }
        if (kiemtraSoLuong() == false) {
            return false;
        }
    });

    function kiemtraDonGia() {
        var bl = true;
        //Duyệt vòng lặp each
        $(".txtDonGia").each(function () {
            var giatri = $(this).val();
            if (isNaN(giatri) == true) {
                alert("Đơn giá không hợp lệ!");
                bl = false;
                return bl;
            } 
            return bl;
        });
    }

    function kiemtraSoLuong() {
        var bl = true;
        //Duyệt vòng lặp each
        $(".txtSoLuong").each(function () {
            var giatri = $(this).val();
            if (isNaN(giatri) == true) {
                alert("Số lượng không hợp lệ!");
                bl = false;
                return bl;
            }
            return bl;
        });
    }

</script>
